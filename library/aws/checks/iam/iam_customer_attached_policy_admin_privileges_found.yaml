########### PLEASE NOTE ###########
# For better readability of the metadata file, kindly remove all the comments before using the template.
###################################

Provider: aws

CheckID: iam_customer_attached_policy_admin_privileges_found

CheckTitle: Detect IAM users with full administrative privileges in customer-managed policies

CheckType:
  - Software and Configuration Checks
  - Identity and Access Management
  - Security Best Practices
  - CIS AWS Foundations Benchmark
  - Compliance Validation

ServiceName: iam

SubServiceName: "iam_user"

ResourceIdTemplate: arn:aws:iam::${AccountId}:user/${UserName}

Severity: high

ResourceType: AwsIamUser

Description: |
  This check identifies IAM users who have customer-managed policies attached that grant full administrative privileges ("*:*").
  It examines each user's attached policies and alerts when overly permissive access rights are found.
  The check specifically focuses on custom policies and excludes AWS-managed policies from the evaluation.

Risk: |
  Granting full administrative privileges through customer-managed policies creates several critical risks:
  1. Unlimited access to all AWS services and resources
  2. Potential for accidental or malicious resource modifications
  3. Violation of least privilege principle
  4. Increased attack surface if credentials are compromised
  5. Non-compliance with security best practices
  6. Difficulty in tracking and auditing user actions
  7. Potential for cascading security failures

RelatedUrl: https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#grant-least-privilege

Remediation:
  Code:
    CLI: |
      # List attached policies for a user
      aws iam list-attached-user-policies --user-name USERNAME
      
      # Detach policy from user
      aws iam detach-user-policy --user-name USERNAME --policy-arn POLICY_ARN
    NativeIaC: |
      Replace full administrative access with specific required permissions in policy documents
    Other: |
      1. Sign in to AWS Management Console
      2. Navigate to IAM
      3. Select Users
      4. For each user:
         - Review attached customer-managed policies
         - Remove or modify policies granting full admin access
         - Replace with least-privilege policies
    Terraform: |
      # Example of proper policy with specific permissions
      resource "aws_iam_user_policy" "example" {
        name = "specific_permissions"
        user = aws_iam_user.example.name
        policy = jsonencode({
          Version = "2012-10-17"
          Statement = [
            {
              Effect = "Allow"
              Action = [
                "s3:ListBucket",
                "s3:GetObject"
              ]
              Resource = [
                "arn:aws:s3:::specific-bucket",
                "arn:aws:s3:::specific-bucket/*"
              ]
            }
          ]
        })
      }
  Recommendation:
    Text: |
      1. Regularly audit user permissions and attached policies
      2. Remove any customer-managed policies granting full admin access
      3. Implement least privilege access:
         - Grant only permissions required for job functions
         - Use AWS managed policies where possible
         - Create specific custom policies when necessary
         - Document all policy assignments
      4. Set up regular policy reviews
      5. Implement policy governance processes
      6. Monitor policy attachment activities
      7. Use AWS Organizations for centralized policy management
    Url: "https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html"

Categories: 
  - security
  - compliance
  - identity_and_access_management
  - least_privilege
  - policy_management

DependsOn: 
  - iam_user_exists
  - iam_policy_no_star_star

RelatedTo: 
  - iam_policy_no_full_access
  - iam_user_no_admin_access
  - iam_policy_attached_to_groups_only
  - iam_user_mfa_enabled
  - iam_customer_policy_blocked_kms_actions

Notes: |
  Infrastructure Protection - Critical Security Control
  This check is essential for:
  - Maintaining secure access control
  - Enforcing least privilege principle
  - Ensuring compliance with security standards
  - Preventing privilege escalation
  - Regular security posture assessment
