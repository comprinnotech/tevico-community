name: Azure VM Managed Disk Encryption Check

description: |
  This check verifies that Azure Virtual Machines have disk encryption enabled on both OS and data disks.
  Disk encryption helps protect data at rest and ensures compliance with security requirements.

service: compute
subservice: virtual_machines

risk: HIGH
muted: false

metadata:
  Provider: Azure
  Category: Security
  Service: Virtual Machines
  Resource: VM Disks
  Severity: High
  RequiredPermissions:
    - Microsoft.Compute/virtualMachines/read
  Documentation:
    - https://docs.microsoft.com/en-us/azure/virtual-machines/disk-encryption-overview
  Tags:
    - security
    - encryption
    - compliance
    - data-protection

remediation: |
  To enable disk encryption on Azure VMs:
  
  1. Using Azure Portal:
     - Navigate to Virtual Machines
     - Select the VM
     - Go to Disks section
     - Enable encryption for OS and data disks
  
  2. Using Azure CLI:
     ```bash
     az vm encryption enable \
       --resource-group myResourceGroup \
       --name myVM \
       --disk-encryption-keyvault myKeyVault
     ```
  
  3. Using PowerShell:
     ```powershell
     Set-AzVMDiskEncryptionExtension \
       -ResourceGroupName "MyResourceGroup" \
       -VMName "MyVM" \
       -DiskEncryptionKeyVaultUrl $KeyVault.VaultUri \
       -DiskEncryptionKeyVaultId $KeyVault.ResourceId
     ```

references:
  - https://docs.microsoft.com/en-us/azure/security/fundamentals/azure-disk-encryption-vms-vmss
  - https://docs.microsoft.com/en-us/azure/virtual-machines/disk-encryption-portal-quickstart
